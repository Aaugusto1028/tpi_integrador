{
	"info": {
		"name": "TPI Log√≠stica (Evaluaci√≥n)",
		"description": "Colecci√≥n automatizada para validar los requisitos del TPI.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "1. Autenticaci√≥n (Tokens)",
			"item": [
				{
					"name": "Obtener Token CLIENTE",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"pm.environment.set(\"token_cliente\", jsonData.access_token);",
									"console.log(\"Token Cliente Capturado\");"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/x-www-form-urlencoded"
							}
						],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{ "key": "client_id", "value": "{{keycloakClient}}", "type": "text" },
								{ "key": "username", "value": "{{user_cliente}}", "type": "text" },
								{ "key": "password", "value": "{{pass_cliente}}", "type": "text" },
								{ "key": "grant_type", "value": "password", "type": "text" }
							]
						},
						"url": {
							"raw": "{{keycloakUrl}}/realms/{{keycloakRealm}}/protocol/openid-connect/token",
							"host": ["{{keycloakUrl}}"],
							"path": ["realms", "{{keycloakRealm}}", "protocol", "openid-connect", "token"]
						}
					}
				},
				{
					"name": "Obtener Token OPERADOR",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"pm.environment.set(\"token_operador\", jsonData.access_token);",
									"console.log(\"Token Operador Capturado\");"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/x-www-form-urlencoded" }
						],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{ "key": "client_id", "value": "{{keycloakClient}}", "type": "text" },
								{ "key": "username", "value": "{{user_operador}}", "type": "text" },
								{ "key": "password", "value": "{{pass_operador}}", "type": "text" },
								{ "key": "grant_type", "value": "password", "type": "text" }
							]
						},
						"url": {
							"raw": "{{keycloakUrl}}/realms/{{keycloakRealm}}/protocol/openid-connect/token",
							"host": ["{{keycloakUrl}}"],
							"path": ["realms", "{{keycloakRealm}}", "protocol", "openid-connect", "token"]
						}
					}
				},
				{
					"name": "Obtener Token TRANSPORTISTA",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"pm.environment.set(\"token_transportista\", jsonData.access_token);",
									"console.log(\"Token Transportista Capturado\");"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/x-www-form-urlencoded" }
						],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{ "key": "client_id", "value": "{{keycloakClient}}", "type": "text" },
								{ "key": "username", "value": "{{user_transportista}}", "type": "text" },
								{ "key": "password", "value": "{{pass_transportista}}", "type": "text" },
								{ "key": "grant_type", "value": "password", "type": "text" }
							]
						},
						"url": {
							"raw": "{{keycloakUrl}}/realms/{{keycloakRealm}}/protocol/openid-connect/token",
							"host": ["{{keycloakUrl}}"],
							"path": ["realms", "{{keycloakRealm}}", "protocol", "openid-connect", "token"]
						}
					}
				}
			]
		},
		{
			"name": "2. Flujo Evaluaci√≥n (Secuencial)",
			"item": [
				{
					"name": "(1) Crear Solicitud [CLIENTE]",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () { pm.response.to.have.status(200); });",
									"var jsonData = pm.response.json();",
									"pm.collectionVariables.set(\"id_solicitud\", jsonData.id);",
									"console.log(\"Solicitud ID: \" + jsonData.id);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_cliente}}", "type": "string" }] },
						"method": "POST",
						"header": [{ "key": "Content-Type", "value": "application/json" }],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"clienteDni\": \"12345678\",\n    \"pesoContenedor\": 500.0,\n    \"volumenContenedor\": 50.0,\n    \"origenLatitud\": -31.4201,\n    \"origenLongitud\": -64.1888,\n    \"destinoLatitud\": -31.4135,\n    \"destinoLongitud\": -64.1810\n}"
						},
						"url": { "raw": "{{baseUrl}}/solicitudes", "host": ["{{baseUrl}}"], "path": ["solicitudes"] }
					}
				},
				{
					"name": "(2) RUTAS ALTERNATIVAS: Crear Primera Ruta [OPERADOR]",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200 or 201\", function () { pm.expect(pm.response.code).to.be.oneOf([200, 201]); });",
									"var jsonData = pm.response.json();",
									"pm.collectionVariables.set(\"id_ruta_1\", jsonData.id);",
									"if(jsonData.tramos && jsonData.tramos.length > 0) {",
									"    pm.collectionVariables.set(\"id_tramo\", jsonData.tramos[0].id);",
									"}",
									"console.log(\"Ruta 1 ID: \" + jsonData.id);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] },
						"method": "POST",
						"header": [{ "key": "Content-Type", "value": "application/json" }],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"idSolicitud\": {{id_solicitud}},\n    \"tramos\": [\n        {\n            \"idDepositoOrigen\": 1,\n            \"idDepositoDestino\": 2,\n            \"idTipoTramo\": 1\n        }\n    ]\n}"
						},
						"url": { "raw": "{{baseUrl}}/rutas", "host": ["{{baseUrl}}"], "path": ["rutas"] }
					}
				},
				{
					"name": "(3) RUTAS ALTERNATIVAS: Crear Segunda Ruta Alternativa [OPERADOR]",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200 or 201\", function () { pm.expect(pm.response.code).to.be.oneOf([200, 201]); });",
									"var jsonData = pm.response.json();",
									"pm.collectionVariables.set(\"id_ruta_2\", jsonData.id);",
									"console.log(\"Ruta 2 ID: \" + jsonData.id);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] },
						"method": "POST",
						"header": [{ "key": "Content-Type", "value": "application/json" }],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"idSolicitud\": {{id_solicitud}},\n    \"tramos\": [\n        {\n            \"idDepositoOrigen\": 1,\n            \"idDepositoDestino\": 3,\n            \"idTipoTramo\": 1\n        },\n        {\n            \"idDepositoOrigen\": 3,\n            \"idDepositoDestino\": 2,\n            \"idTipoTramo\": 1\n        }\n    ]\n}"
						},
						"url": { "raw": "{{baseUrl}}/rutas", "host": ["{{baseUrl}}"], "path": ["rutas"] }
					}
				},
				{
					"name": "(4) RUTAS ALTERNATIVAS: Consultar Todas las Rutas [OPERADOR]",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () { pm.response.to.have.status(200); });",
									"var jsonData = pm.response.json();",
									"console.log(\"Rutas alternativas encontradas: \" + jsonData.length);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] },
						"method": "GET",
						"header": [],
						"url": { "raw": "{{baseUrl}}/rutas/solicitud/{{id_solicitud}}", "host": ["{{baseUrl}}"], "path": ["rutas", "solicitud", "{{id_solicitud}}"] }
					}
				},
				{
					"name": "(5) RUTAS ALTERNATIVAS: Elegir Ruta [OPERADOR]",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if (jsonData && jsonData.tramos && jsonData.tramos.length > 0) {",
									"    pm.collectionVariables.set(\"id_tramo\", jsonData.tramos[0].id);",
									"    console.log(\"=== RUTA ELEGIDA ===\");",
									"    console.log(\"Cantidad de tramos: \" + jsonData.tramos.length);",
									"    console.log(\"\\nIDs de todos los tramos:\");",
									"    for (var i = 0; i < jsonData.tramos.length; i++) {",
									"        console.log(\"  Tramo \" + (i+1) + \": \" + jsonData.tramos[i].id + \" (\" + jsonData.tramos[i].depositoOrigen + \" ‚Üí \" + jsonData.tramos[i].depositoDestino + \")\");",
									"    }",
									"    console.log(\"\\nPRIMER TRAMO CARGADO en id_tramo: \" + jsonData.tramos[0].id);",
									"    if (jsonData.tramos.length > 1) {",
									"        console.log(\"\\n‚ö†Ô∏è  IMPORTANTE: Esta ruta tiene \" + jsonData.tramos.length + \" tramos.\");",
									"        console.log(\"Debes ejecutar el paso (6) Asignar Cami√≥n \" + jsonData.tramos.length + \" veces:\");",
									"        for (var i = 1; i < jsonData.tramos.length; i++) {",
									"            console.log(\"  - Ejecuci√≥n \" + (i+1) + \": Cambia id_tramo a \" + jsonData.tramos[i].id + \" antes de ejecutar\");",
									"        }",
									"    }",
									"}",
									"console.log(\"\\n‚úÖ Ruta elegida. Rutas alternativas descartadas.\");"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] },
						"method": "POST",
						"header": [],
						"url": { "raw": "{{baseUrl}}/rutas/{{id_ruta_1}}/elegir", "host": ["{{baseUrl}}"], "path": ["rutas", "{{id_ruta_1}}", "elegir"] }
					}
				},
				{
					"name": "(6a) Obtener Camiones Disponibles [OPERADOR]",
					"description": "Consulta qu√© camiones est√°n disponibles. Guarda la lista para que (6) pueda asignarlos autom√°ticamente sin repetir.",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"console.log(\"=== CAMIONES DISPONIBLES ===\");",
									"",
									"if (jsonData && Array.isArray(jsonData) && jsonData.length > 0) {",
									"    var patentes = [];",
									"    for (var i = 0; i < jsonData.length; i++) {",
									"        var camion = jsonData[i];",
									"        patentes.push(camion.patente);",
									"        console.log(\"\\n\" + (i+1) + \". Patente: \" + camion.patente);",
									"        console.log(\"   Capacidad Peso: \" + camion.capacidadPeso + \" kg\");",
									"        console.log(\"   Capacidad Volumen: \" + camion.capacidadVolumen + \" m¬≥\");",
									"        console.log(\"   Consumo: \" + camion.consumoCombustibleKm + \" L/km\");",
									"        console.log(\"   Costo por km: \" + camion.costoPorKm);",
									"    }",
									"    ",
									"    // Guardar lista de patentes disponibles",
									"    pm.collectionVariables.set(\"camiones_disponibles\", JSON.stringify(patentes));",
									"    // Inicializar contador de asignaciones",
									"    pm.collectionVariables.set(\"camion_index\", 0);",
									"    // Inicializar array de usados",
									"    pm.collectionVariables.set(\"camiones_usados\", JSON.stringify([]));",
									"    ",
									"    console.log(\"\\n‚úÖ Guardadas \" + patentes.length + \" patentes disponibles\");",
									"    console.log(\"Paso (6) las asignar√° autom√°ticamente sin repetir.\");",
									"} else {",
									"    console.log(\"‚ùå ERROR: No hay camiones disponibles\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] },
						"method": "GET",
						"header": [],
						"url": { "raw": "{{baseUrl}}/camiones/buscar-apto?peso=500&volumen=50", "host": ["{{baseUrl}}"], "path": ["camiones", "buscar-apto"], "query": [{ "key": "peso", "value": "500" }, { "key": "volumen", "value": "50" }] }
					}
				},
				{
					"name": "(6) Asignar Cami√≥n [OPERADOR] - AUTOM√ÅTICO Y SIN REPETIR",
					"description": "Asigna autom√°ticamente el siguiente cami√≥n disponible (sin repetir). Repite este paso para cada tramo. IMPORTANTE: Ejecuta (6a) primero para obtener la lista de camiones.",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// Obtener lista de camiones disponibles",
									"var camionesStr = pm.collectionVariables.get(\"camiones_disponibles\");",
									"var camionesUsadosStr = pm.collectionVariables.get(\"camiones_usados\");",
									"",
									"if (!camionesStr) {",
									"    console.error(\"‚ùå ERROR: No hay camiones disponibles. Ejecuta primero el paso (6a)\");",
									"    throw new Error(\"Debes ejecutar primero el paso (6a) Obtener Camiones Disponibles\");",
									"}",
									"",
									"var camiones = JSON.parse(camionesStr);",
									"var camionesUsados = JSON.parse(camionesUsadosStr || '[]');",
									"var index = parseInt(pm.collectionVariables.get(\"camion_index\") || 0);",
									"",
									"// Buscar siguiente cami√≥n no usado",
									"var camionAsignar = null;",
									"for (var i = index; i < camiones.length; i++) {",
									"    if (camionesUsados.indexOf(camiones[i]) === -1) {",
									"        camionAsignar = camiones[i];",
									"        index = i + 1;",
									"        break;",
									"    }",
									"}",
									"",
									"if (!camionAsignar) {",
									"    console.error(\"‚ùå ERROR: No hay m√°s camiones disponibles sin usar. Se necesitar√≠an \" + camionesUsados.length + \" y solo hay \" + camiones.length);",
									"    throw new Error(\"No hay m√°s camiones disponibles. Todos est√°n asignados.\");",
									"}",
									"",
									"// Guardar √≠ndice para siguiente iteraci√≥n",
									"pm.collectionVariables.set(\"camion_index\", index);",
									"",
									"// Agregar a usados",
									"camionesUsados.push(camionAsignar);",
									"pm.collectionVariables.set(\"camiones_usados\", JSON.stringify(camionesUsados));",
									"",
									"// Reemplazar en body",
									"var body = pm.request.body.raw;",
									"body = body.replace(/\\\"patenteCamion\\\":\\s*\\\"[^\\\"]*\\\"/g, '\\\"patenteCamion\\\": \\\"' + camionAsignar + '\\\"');",
									"pm.request.body.raw = body;",
									"",
									"console.log(\"üöó Asignando cami√≥n: \" + camionAsignar + \" (\" + camionesUsados.length + \" de \" + camiones.length + \")\");"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    var camionAsignado = JSON.parse(pm.request.body.raw).patenteCamion;",
									"    console.log(\"‚úÖ Cami√≥n \" + camionAsignado + \" asignado exitosamente\");",
									"} else {",
									"    console.error(\"‚ùå Error asignando cami√≥n: \" + pm.response.status);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] },
						"method": "PUT",
						"header": [{ "key": "Content-Type", "value": "application/json" }],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"patenteCamion\": \"ABC123\",\n    \"pesoContenedor\": 500.0,\n    \"volumenContenedor\": 50.0\n}"
						},
						"url": { "raw": "{{baseUrl}}/tramos/{{id_tramo}}/asignar-camion", "host": ["{{baseUrl}}"], "path": ["tramos", "{{id_tramo}}", "asignar-camion"] }
					}
				},
				{
					"name": "(7) Iniciar Tramo [TRANSPORTISTA] - REPETIR SI MULTIPLES TRAMOS",
					"description": "Inicia un tramo (marca fechaHoraInicio). Si hay multiples tramos, repite para cada uno cambiando id_tramo.",
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_transportista}}", "type": "string" }] },
						"method": "POST",
						"header": [],
						"url": { "raw": "{{baseUrl}}/tramos/{{id_tramo}}/iniciar", "host": ["{{baseUrl}}"], "path": ["tramos", "{{id_tramo}}", "iniciar"] }
					}
				},
				{
					"name": "(8) Finalizar Tramo [TRANSPORTISTA] - REPETIR SI MULTIPLES TRAMOS",
					"description": "Finaliza un tramo (marca fechaHoraFin y calcula costoReal). Si hay multiples tramos, repite para cada uno cambiando id_tramo.",
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_transportista}}", "type": "string" }] },
						"method": "POST",
						"header": [],
						"url": { "raw": "{{baseUrl}}/tramos/{{id_tramo}}/finalizar", "host": ["{{baseUrl}}"], "path": ["tramos", "{{id_tramo}}", "finalizar"] }
					}
				},
				{
					"name": "(9) Seguimiento Solicitud [CLIENTE]",
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_cliente}}", "type": "string" }] },
						"method": "GET",
						"header": [],
						"url": { "raw": "{{baseUrl}}/solicitudes/{{id_solicitud}}/estado", "host": ["{{baseUrl}}"], "path": ["solicitudes", "{{id_solicitud}}", "estado"] }
					}
				},
				{
					"name": "(10) Finalizar Solicitud [OPERADOR]",
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] },
						"method": "PUT",
						"header": [{ "key": "Content-Type", "value": "application/json" }],
						"body": {
							"mode": "raw",
							"raw": "{}"
						},
						"url": { "raw": "{{baseUrl}}/solicitudes/{{id_solicitud}}/finalizar", "host": ["{{baseUrl}}"], "path": ["solicitudes", "{{id_solicitud}}", "finalizar"] }
					}
				}
			]
		}
	],
	"variable": [
		{ "key": "id_solicitud", "value": "" },
		{ "key": "id_tramo", "value": "" },
		{ "key": "id_ruta_1", "value": "" },
		{ "key": "id_ruta_2", "value": "" }
	]
}