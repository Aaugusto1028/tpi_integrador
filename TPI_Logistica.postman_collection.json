{
  "info": {
    "name": "TPI Logística",
    "description": "Colección para pruebas de la arquitectura: API Gateway + ms-solicitudes, ms-rutas, ms-camiones; Keycloak para auth.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "version": "1.0.0"
  },
  "item": [
    {
      "name": "1. Autenticación (Keycloak)",
      "item": [
        {
          "name": "Obtener Token CLIENTE",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/x-www-form-urlencoded" }
            ],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                { "key": "grant_type", "value": "password" },
                { "key": "client_id", "value": "{{keycloakClient}}" },
                { "key": "username", "value": "{{user_cliente}}" },
                { "key": "password", "value": "{{pass_cliente}}" }
              ]
            },
            "url": {
              "raw": "{{keycloakUrl}}/realms/{{keycloakRealm}}/protocol/openid-connect/token",
              "host": ["{{keycloakUrl}}"],
              "path": ["realms","{{keycloakRealm}}","protocol","openid-connect","token"]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code !== 200) {",
                  "  pm.test('Token request failed', function(){pm.response.to.have.status(200);});",
                  "} else {",
                  "  var json = pm.response.json();",
                  "  pm.collectionVariables.set('token_cliente', json.access_token);",
                  "  pm.environment.set('token_cliente', json.access_token);",
                  "  pm.test('Token saved', function(){pm.expect(json).to.have.property('access_token');});",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Obtener Token OPERADOR",
          "request": {
            "method": "POST",
            "header": [ { "key": "Content-Type", "value": "application/x-www-form-urlencoded" } ],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                { "key": "grant_type", "value": "password" },
                { "key": "client_id", "value": "{{keycloakClient}}" },
                { "key": "username", "value": "{{user_operador}}" },
                { "key": "password", "value": "{{pass_operador}}" }
              ]
            },
            "url": { "raw": "{{keycloakUrl}}/realms/{{keycloakRealm}}/protocol/openid-connect/token","host":["{{keycloakUrl}}"],"path":["realms","{{keycloakRealm}}","protocol","openid-connect","token"] }
          },
          "event": [ { "listen": "test", "script": { "exec": [ "if (pm.response.code !== 200) {","  pm.test('Token request failed', function(){pm.response.to.have.status(200);});","} else {","  var json = pm.response.json();","  pm.collectionVariables.set('token_operador', json.access_token);","  pm.environment.set('token_operador', json.access_token);","  pm.test('Token saved', function(){pm.expect(json).to.have.property('access_token');});","}" ] } } ]
        },
        {
          "name": "Obtener Token TRANSPORTISTA",
          "request": {
            "method": "POST",
            "header": [ { "key": "Content-Type", "value": "application/x-www-form-urlencoded" } ],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                { "key": "grant_type", "value": "password" },
                { "key": "client_id", "value": "{{keycloakClient}}" },
                { "key": "username", "value": "{{user_transportista}}" },
                { "key": "password", "value": "{{pass_transportista}}" }
              ]
            },
            "url": { "raw": "{{keycloakUrl}}/realms/{{keycloakRealm}}/protocol/openid-connect/token","host":["{{keycloakUrl}}"],"path":["realms","{{keycloakRealm}}","protocol","openid-connect","token"] }
          },
          "event": [ { "listen": "test", "script": { "exec": [ "if (pm.response.code !== 200) {","  pm.test('Token request failed', function(){pm.response.to.have.status(200);});","} else {","  var json = pm.response.json();","  pm.collectionVariables.set('token_transportista', json.access_token);","  pm.environment.set('token_transportista', json.access_token);","  pm.test('Token saved', function(){pm.expect(json).to.have.property('access_token');});","}" ] } } ]
        }
      ]
    },
    {
      "name": "2. Flujo Principal (Demo)",
      "item": [
        {
          "name": "(CLIENTE) Crear Solicitud",
          "request": {
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_cliente}}", "type": "string" }] },
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{\n  \"clienteDni\": \"12345678\",\n  \"pesoContenedor\": 500,\n  \"volumenContenedor\": 1000,\n  \"origenLatitud\": -31.4201,\n  \"origenLongitud\": -64.1888,\n  \"destinoLatitud\": -31.5350,\n  \"destinoLongitud\": -64.2637\n}" },
            "url": { "raw": "{{baseUrl}}/solicitudes", "host": ["{{baseUrl}}"], "path": ["solicitudes"] }
          },
          "event": [ { "listen": "test", "script": { "exec": [ "pm.test('status 201 or 200', function(){pm.expect(pm.response.code).to.be.oneOf([200,201]);});","var json = pm.response.json();","if (json && json.id) {","  pm.collectionVariables.set('id_solicitud_creada', json.id);","  console.log('id_solicitud_creada =', json.id);","}","pm.test('response has id', function(){pm.expect(json).to.have.property('id');});" ] } } ]
        },
        {
          "name": "(OPERADOR) Crear Ruta",
          "request": {
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] },
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{\n  \"idSolicitud\": {{id_solicitud_creada}},\n  \"tramos\": [\n    { \"idDepositoOrigen\": 1, \"idDepositoDestino\": 2, \"idTipoTramo\": 1 }\n  ]\n}" },
            "url": { "raw": "{{baseUrl}}/rutas", "host": ["{{baseUrl}}"], "path": ["rutas"] }
          },
          "event": [ { "listen": "test", "script": { "exec": [ "pm.test('status 201 or 200', function(){pm.expect(pm.response.code).to.be.oneOf([200,201]);});","var json = pm.response.json();","if (json && json.id) { pm.collectionVariables.set('id_ruta_creada', json.id); }","if (json && json.tramos && json.tramos.length) {","  pm.collectionVariables.set('id_tramo_1', json.tramos[0].id || json.tramos[0].idTramo || json.tramos[0].id_tramo);","}","pm.test('ruta response has id', function(){pm.expect(json).to.have.property('id');});" ] } } ]
        },
        {
          "name": "(OPERADOR) Asignar Camión a Tramo",
          "request": {
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] },
            "method": "PUT",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{\n  \"patenteCamion\": \"ABC123\",\n  \"pesoContenedor\": 500,\n  \"volumenContenedor\": 1000\n}" },
            "url": { "raw": "{{baseUrl}}/tramos/{{id_tramo_1}}/asignar-camion", "host": ["{{baseUrl}}"], "path": ["tramos","{{id_tramo_1}}","asignar-camion"] }
          },
          "event": [ { "listen": "test", "script": { "exec": [ "pm.test('status 200', function(){pm.expect(pm.response.code).to.be.oneOf([200,204]);});","pm.collectionVariables.set('patente_usada', 'ABC123');" ] } } ]
        },
        {
          "name": "(TRANSPORTISTA) Iniciar Tramo",
          "request": {
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_transportista}}", "type": "string" }] },
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{}" },
            "url": { "raw": "{{baseUrl}}/tramos/{{id_tramo_1}}/iniciar", "host": ["{{baseUrl}}"], "path": ["tramos","{{id_tramo_1}}","iniciar"] }
          },
          "event": [ { "listen": "test", "script": { "exec": [ "pm.test('status ok', function(){pm.expect(pm.response.code).to.be.oneOf([200,204]);});","pm.collectionVariables.set('tramo_iniciado', '{{id_tramo_1}}');" ] } } ]
        },
        {
          "name": "(TRANSPORTISTA) Finalizar Tramo",
          "request": {
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_transportista}}", "type": "string" }] },
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{}" },
            "url": { "raw": "{{baseUrl}}/tramos/{{id_tramo_1}}/finalizar", "host": ["{{baseUrl}}"], "path": ["tramos","{{id_tramo_1}}","finalizar"] }
          },
          "event": [ { "listen": "test", "script": { "exec": [ "pm.test('status ok', function(){pm.expect(pm.response.code).to.be.oneOf([200,204]);});","pm.collectionVariables.set('tramo_finalizado', '{{id_tramo_1}}');" ] } } ]
        },
        {
          "name": "(OPERADOR) Finalizar Solicitud",
          "request": {
            "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] },
            "method": "PUT",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{ \"fechaFinalizacion\": \"2025-11-17T18:00:00Z\" }" },
            "url": { "raw": "{{baseUrl}}/solicitudes/{{id_solicitud_creada}}/finalizar", "host": ["{{baseUrl}}"], "path": ["solicitudes","{{id_solicitud_creada}}","finalizar"] }
          },
          "event": [ { "listen": "test", "script": { "exec": [ "pm.test('status ok', function(){pm.expect(pm.response.code).to.be.oneOf([200,204]);});" ] } } ]
        }
      ]
    },
    {
      "name": "3. Endpoints (CRUD)",
      "item": [
        {
          "name": "ms-solicitudes",
          "item": [
            {
              "name": "Crear Solicitud (CRUD)",
              "request": {
                "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_cliente}}", "type": "string" }] },
                "method": "POST",
                "header": [{ "key": "Content-Type", "value": "application/json" }],
                "body": { "mode": "raw", "raw": "{\n  \"clienteDni\": \"87654321\",\n  \"pesoContenedor\": 750,\n  \"volumenContenedor\": 1500,\n  \"origenLatitud\": -31.4201,\n  \"origenLongitud\": -64.1888,\n  \"destinoLatitud\": -31.5350,\n  \"destinoLongitud\": -64.2637\n}" },
                "url": { "raw": "{{baseUrl}}/solicitudes", "host": ["{{baseUrl}}"], "path": ["solicitudes"] }
              },
              "event": [ { "listen": "test", "script": { "exec": [ "var json = pm.response.json();","if (json && json.id) { pm.collectionVariables.set('id_solicitud_creada', json.id); }" ] } } ]
            },
            {
              "name": "Listar Solicitudes",
              "request": { "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] }, "method": "GET", "url": { "raw": "{{baseUrl}}/solicitudes", "host": ["{{baseUrl}}"], "path": ["solicitudes"] } }
            },
            {
              "name": "Obtener Solicitud por ID",
              "request": { "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] }, "method": "GET", "url": { "raw": "{{baseUrl}}/solicitudes/{{id_solicitud_creada}}", "host": ["{{baseUrl}}"], "path": ["solicitudes","{{id_solicitud_creada}}"] } }
            },
            {
              "name": "Obtener Estado de Solicitud",
              "request": { "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] }, "method": "GET", "url": { "raw": "{{baseUrl}}/solicitudes/{{id_solicitud_creada}}/estado", "host": ["{{baseUrl}}"], "path": ["solicitudes","{{id_solicitud_creada}}","estado"] } }
            }
          ]
        },
        {
          "name": "ms-rutas",
          "item": [
            {
              "name": "Crear Ruta (CRUD)",
              "request": {
                "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] },
                "method": "POST",
                "header": [{ "key": "Content-Type", "value": "application/json" }],
                "body": { "mode": "raw", "raw": "{\n  \"idSolicitud\": {{id_solicitud_creada}},\n  \"tramos\": [{ \"idDepositoOrigen\": 1, \"idDepositoDestino\": 2, \"idTipoTramo\": 1 }]\n}" },
                "url": { "raw": "{{baseUrl}}/rutas", "host": ["{{baseUrl}}"], "path": ["rutas"] }
              },
              "event": [ { "listen": "test", "script": { "exec": [ "var json = pm.response.json();","if (json && json.id) { pm.collectionVariables.set('id_ruta_creada', json.id); }","if (json && json.tramos && json.tramos.length) { pm.collectionVariables.set('id_tramo_1', json.tramos[0].id || json.tramos[0].idTramo); }" ] } } ]
            },
            {
              "name": "Listar Rutas (Paginado)",
              "request": { "auth": { "type": "bearer", "bearer": [{ "key": "token_operador", "value": "{{token_operador}}", "type": "string" }] }, "method": "GET", "url": { "raw": "{{baseUrl}}/rutas?page=0&size=20", "host": ["{{baseUrl}}"], "path": ["rutas"], "query": [{ "key":"page","value":"0"},{ "key":"size","value":"20"}] } }
            },
            {
              "name": "Obtener Rutas por Solicitud",
              "request": { "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] }, "method": "GET", "url": { "raw": "{{baseUrl}}/rutas/solicitud/{{id_solicitud_creada}}", "host": ["{{baseUrl}}"], "path": ["rutas","solicitud","{{id_solicitud_creada}}"] } }
            },
            {
              "name": "Obtener Ruta por ID",
              "request": { "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] }, "method": "GET", "url": { "raw": "{{baseUrl}}/rutas/{{id_ruta_creada}}", "host": ["{{baseUrl}}"], "path": ["rutas","{{id_ruta_creada}}"] } }
            },
            {
              "name": "Asignar Ruta",
              "request": { "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] }, "method": "POST", "body": { "mode": "raw", "raw": "{}" }, "url": { "raw": "{{baseUrl}}/rutas/{{id_ruta_creada}}/asignar", "host": ["{{baseUrl}}"], "path": ["rutas","{{id_ruta_creada}}","asignar"] } }
            },
            {
              "name": "Obtener Costo de Traslado Real",
              "request": { "method": "GET", "auth": { "type": "noauth" }, "url": { "raw": "{{baseUrl}}/rutas/solicitud/{{id_solicitud_creada}}/costo-real", "host": ["{{baseUrl}}"], "path": ["rutas","solicitud","{{id_solicitud_creada}}","costo-real"] } }
            },
            {
              "name": "Obtener Tarifas Vigentes",
              "request": { "method": "GET", "auth": { "type": "noauth" }, "url": { "raw": "{{baseUrl}}/rutas/tarifas", "host": ["{{baseUrl}}"], "path": ["rutas","tarifas"] } }
            },
            {
              "name": "Asignar Camión a Tramo (ms-rutas)",
              "request": { "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] }, "method": "PUT", "header": [{ "key": "Content-Type", "value": "application/json" }], "body": { "mode": "raw", "raw": "{\n  \"patenteCamion\": \"ABC123\",\n  \"pesoContenedor\": 500,\n  \"volumenContenedor\": 1000\n}" }, "url": { "raw": "{{baseUrl}}/tramos/{{id_tramo_1}}/asignar-camion", "host": ["{{baseUrl}}"], "path": ["tramos","{{id_tramo_1}}","asignar-camion"] } }
            },
            {
              "name": "Iniciar Tramo (ms-rutas)",
              "request": { "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_transportista}}", "type": "string" }] }, "method": "POST", "body": { "mode": "raw", "raw": "{}" }, "url": { "raw": "{{baseUrl}}/tramos/{{id_tramo_1}}/iniciar", "host": ["{{baseUrl}}"], "path": ["tramos","{{id_tramo_1}}","iniciar"] } }
            },
            {
              "name": "Finalizar Tramo (ms-rutas)",
              "request": { "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_transportista}}", "type": "string" }] }, "method": "POST", "body": { "mode": "raw", "raw": "{}" }, "url": { "raw": "{{baseUrl}}/tramos/{{id_tramo_1}}/finalizar", "host": ["{{baseUrl}}"], "path": ["tramos","{{id_tramo_1}}","finalizar"] } }
            }
          ]
        },
        {
          "name": "ms-camiones",
          "item": [
            {
              "name": "Crear Camión",
              "request": { "method": "POST", "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] }, "header": [{ "key": "Content-Type", "value": "application/json" }], "body": { "mode": "raw", "raw": "{\n  \"patente\": \"ABC123\",\n  \"modelo\": \"Volvo FH16\",\n  \"capacidadPeso\": 25000,\n  \"capacidadVolumen\": 80,\n  \"disponible\": true\n}" }, "url": { "raw": "{{baseUrl}}/camiones", "host": ["{{baseUrl}}"], "path": ["camiones"] } }
            },
            {
              "name": "Listar Camiones",
              "request": { "method": "GET", "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] }, "url": { "raw": "{{baseUrl}}/camiones", "host": ["{{baseUrl}}"], "path": ["camiones"] } }
            },
            {
              "name": "Obtener Camiones Aptos",
              "request": { "method": "GET", "auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] }, "url": { "raw": "{{baseUrl}}/camiones/aptos", "host": ["{{baseUrl}}"], "path": ["camiones","aptos"] } }
            }
          ]
        }
      ]
    }
  ],
  "event": [],
  "variable": [
    { "key": "id_solicitud_creada", "value": "" },
    { "key": "id_ruta_creada", "value": "" },
    { "key": "id_tramo_1", "value": "" },
    { "key": "patente_usada", "value": "" }
  ]
}
