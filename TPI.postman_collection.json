{
	"info": {
		"name": "TPI Logística (Evaluación)",
		"description": "Colección automatizada para validar los requisitos del TPI.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "1. Autenticación (Tokens)",
			"item": [
				{
					"name": "Obtener Token CLIENTE",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"pm.environment.set(\"token_cliente\", jsonData.access_token);",
									"console.log(\"Token Cliente Capturado\");"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/x-www-form-urlencoded"
							}
						],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{ "key": "client_id", "value": "{{keycloakClient}}", "type": "text" },
								{ "key": "username", "value": "{{user_cliente}}", "type": "text" },
								{ "key": "password", "value": "{{pass_cliente}}", "type": "text" },
								{ "key": "grant_type", "value": "password", "type": "text" }
							]
						},
						"url": {
							"raw": "{{keycloakUrl}}/realms/{{keycloakRealm}}/protocol/openid-connect/token",
							"host": ["{{keycloakUrl}}"],
							"path": ["realms", "{{keycloakRealm}}", "protocol", "openid-connect", "token"]
						}
					}
				},
				{
					"name": "Obtener Token OPERADOR",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"pm.environment.set(\"token_operador\", jsonData.access_token);",
									"console.log(\"Token Operador Capturado\");"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/x-www-form-urlencoded" }
						],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{ "key": "client_id", "value": "{{keycloakClient}}", "type": "text" },
								{ "key": "username", "value": "{{user_operador}}", "type": "text" },
								{ "key": "password", "value": "{{pass_operador}}", "type": "text" },
								{ "key": "grant_type", "value": "password", "type": "text" }
							]
						},
						"url": {
							"raw": "{{keycloakUrl}}/realms/{{keycloakRealm}}/protocol/openid-connect/token",
							"host": ["{{keycloakUrl}}"],
							"path": ["realms", "{{keycloakRealm}}", "protocol", "openid-connect", "token"]
						}
					}
				},
				{
					"name": "Obtener Token TRANSPORTISTA",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"pm.environment.set(\"token_transportista\", jsonData.access_token);",
									"console.log(\"Token Transportista Capturado\");"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/x-www-form-urlencoded" }
						],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{ "key": "client_id", "value": "{{keycloakClient}}", "type": "text" },
								{ "key": "username", "value": "{{user_transportista}}", "type": "text" },
								{ "key": "password", "value": "{{pass_transportista}}", "type": "text" },
								{ "key": "grant_type", "value": "password", "type": "text" }
							]
						},
						"url": {
							"raw": "{{keycloakUrl}}/realms/{{keycloakRealm}}/protocol/openid-connect/token",
							"host": ["{{keycloakUrl}}"],
							"path": ["realms", "{{keycloakRealm}}", "protocol", "openid-connect", "token"]
						}
					}
				}
			]
		},
		{
			"name": "2. Flujo Evaluación (Secuencial)",
			"item": [
				{
					"name": "(1) Crear Solicitud [CLIENTE]",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () { pm.response.to.have.status(200); });",
									"var jsonData = pm.response.json();",
									"pm.collectionVariables.set(\"id_solicitud\", jsonData.id);",
									"console.log(\"Solicitud ID: \" + jsonData.id);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_cliente}}", "type": "string" }] },
						"method": "POST",
						"header": [{ "key": "Content-Type", "value": "application/json" }],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"clienteDni\": \"12345678\",\n    \"pesoContenedor\": 500.0,\n    \"volumenContenedor\": 50.0,\n    \"origenLatitud\": -31.4201,\n    \"origenLongitud\": -64.1888,\n    \"destinoLatitud\": -31.4135,\n    \"destinoLongitud\": -64.1810\n}"
						},
						"url": { "raw": "{{baseUrl}}/solicitudes", "host": ["{{baseUrl}}"], "path": ["solicitudes"] }
					}
				},
				{
					"name": "(2) Crear Ruta [OPERADOR]",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200 or 201\", function () { pm.expect(pm.response.code).to.be.oneOf([200, 201]); });",
									"var jsonData = pm.response.json();",
									"// Capturamos el ID del primer tramo para asignarle camión",
									"if(jsonData.tramos && jsonData.tramos.length > 0) {",
									"    pm.collectionVariables.set(\"id_tramo\", jsonData.tramos[0].id);",
									"    console.log(\"Tramo ID: \" + jsonData.tramos[0].id);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] },
						"method": "POST",
						"header": [{ "key": "Content-Type", "value": "application/json" }],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"idSolicitud\": {{id_solicitud}},\n    \"tramos\": [\n        {\n            \"idDepositoOrigen\": 1,\n            \"idDepositoDestino\": 2,\n            \"idTipoTramo\": 1\n        }\n    ]\n}"
						},
						"url": { "raw": "{{baseUrl}}/rutas", "host": ["{{baseUrl}}"], "path": ["rutas"] }
					}
				},
				{
					"name": "(3) Asignar Camión [OPERADOR]",
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] },
						"method": "PUT",
						"header": [{ "key": "Content-Type", "value": "application/json" }],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"patenteCamion\": \"ABC123\",\n    \"pesoContenedor\": 500.0,\n    \"volumenContenedor\": 50.0\n}"
						},
						"url": { "raw": "{{baseUrl}}/tramos/{{id_tramo}}/asignar-camion", "host": ["{{baseUrl}}"], "path": ["tramos", "{{id_tramo}}", "asignar-camion"] }
					}
				},
				{
					"name": "(4) Iniciar Tramo [TRANSPORTISTA]",
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_transportista}}", "type": "string" }] },
						"method": "POST",
						"header": [],
						"url": { "raw": "{{baseUrl}}/tramos/{{id_tramo}}/iniciar", "host": ["{{baseUrl}}"], "path": ["tramos", "{{id_tramo}}", "iniciar"] }
					}
				},
				{
					"name": "(5) Finalizar Tramo [TRANSPORTISTA]",
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_transportista}}", "type": "string" }] },
						"method": "POST",
						"header": [],
						"url": { "raw": "{{baseUrl}}/tramos/{{id_tramo}}/finalizar", "host": ["{{baseUrl}}"], "path": ["tramos", "{{id_tramo}}", "finalizar"] }
					}
				},
				{
					"name": "(6) Seguimiento Solicitud [CLIENTE]",
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_cliente}}", "type": "string" }] },
						"method": "GET",
						"header": [],
						"url": { "raw": "{{baseUrl}}/solicitudes/{{id_solicitud}}/estado", "host": ["{{baseUrl}}"], "path": ["solicitudes", "{{id_solicitud}}", "estado"] }
					}
				},
				{
					"name": "(7) Finalizar Solicitud [OPERADOR]",
					"request": {
						"auth": { "type": "bearer", "bearer": [{ "key": "token", "value": "{{token_operador}}", "type": "string" }] },
						"method": "PUT",
						"header": [{ "key": "Content-Type", "value": "application/json" }],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"costoFinal\": 15000.00,\n    \"tiempoReal\": 48.5\n}"
						},
						"url": { "raw": "{{baseUrl}}/solicitudes/{{id_solicitud}}/finalizar", "host": ["{{baseUrl}}"], "path": ["solicitudes", "{{id_solicitud}}", "finalizar"] }
					}
				}
			]
		}
	],
	"variable": [
		{ "key": "id_solicitud", "value": "" },
		{ "key": "id_tramo", "value": "" }
	]
}